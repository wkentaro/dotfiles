#!/usr/bin/env python

import argparse
import datetime
import os

from selenium import webdriver
from selenium.webdriver.support.ui import Select


def date_type(value):
    date = datetime.datetime.strptime(value, "%Y-%m-%d").date()
    today = datetime.datetime.today().date()
    assert date - today >= datetime.timedelta(days=4)
    return value


parser = argparse.ArgumentParser(
    formatter_class=argparse.ArgumentDefaultsHelpFormatter,
)
parser.add_argument(
    "--dates", type=date_type, nargs="+", help="dates", required=True
)
args = parser.parse_args()

USERNAME = os.environ["IMPERIAL_USERNAME"]
PASSWORD = os.environ["IMPERIAL_PASSWORD"]
CID = os.environ["IMPERIAL_CID"]
PURPOSE = "Research on the desktop computer in the lab."

driver = webdriver.Chrome()
driver.implicitly_wait(5)
driver.get(
    f"https://{USERNAME}:{PASSWORD}@www.doc.ic.ac.uk/~dcw/secure/requestvisit/visit"  # NOQA
)
for date in args.dates:
    for is_am in [True, False]:
        Select(driver.find_element_by_name("room")).select_by_value(
            "WPL 301"
        )

        element = driver.find_element_by_name("cid")
        element.clear()
        element.send_keys(CID)

        Select(driver.find_element_by_name("visdate")).select_by_value(
            date
        )
        Select(driver.find_element_by_name("am")).select_by_value(
            "t" if is_am else "f"
        )

        element = driver.find_element_by_name("purpose")
        element.clear()
        element.send_keys(PURPOSE)

        driver.find_element_by_name("Add Visit").click()
