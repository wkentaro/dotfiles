#!/usr/bin/env python

import argparse
import datetime
import os

from selenium import webdriver
from selenium.webdriver.support.ui import Select


def date_type(value):
    date = datetime.datetime.strptime(value, "%Y-%m-%d").date()
    today = datetime.datetime.today().date()
    assert date - today >= datetime.timedelta(days=4)
    return value


parser = argparse.ArgumentParser(
    formatter_class=argparse.ArgumentDefaultsHelpFormatter,
)
parser.add_argument("--dates", type=date_type, default=[], nargs="*")
parser.add_argument("--submit", action="store_true", help=" ")
args = parser.parse_args()

USERNAME = os.environ["IMPERIAL_USERNAME"]
PASSWORD = os.environ["IMPERIAL_PASSWORD"]
CID = os.environ["IMPERIAL_CID"]
PURPOSE = "Research on the desktop computer in the lab."

driver = webdriver.Chrome()
driver.implicitly_wait(5)
driver.get(
    f"https://{USERNAME}:{PASSWORD}@www.doc.ic.ac.uk/~dcw/secure/requestvisit/visit"  # NOQA
)
Select(driver.find_element_by_name("room")).select_by_value("301 (Approver Andrew Davison)")

element = driver.find_element_by_name("cid")
element.clear()
element.send_keys(CID)

element = driver.find_element_by_name("purpose")
element.clear()
element.send_keys(PURPOSE)
for date in args.dates:
    Select(driver.find_element_by_name("visdate")).select_by_value(date)
    if not args.submit:
        driver.find_element_by_name("Add Visit").click()
